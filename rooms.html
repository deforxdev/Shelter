<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobbies - Shelter</title>
    <link rel="stylesheet" href="rooms.css">
    <link href="https://fonts.googleapis.com/css2?family=Kenia&family=Kelly+Slab&family=Impact&display=swap" rel="stylesheet">
</head>
<body>
    <div class="rooms-page">
        <!-- Background -->
        <div class="background"></div>
        
        <!-- Header/Navigation -->
        <header class="header">
            <div class="header-bar"></div>
            
            <!-- Logo -->
            <div class="header-logo">
                <img src="Assets/Component 1.png" alt="Shelter" class="header-icon">
                <span class="header-title">Shelter</span>
            </div>
            
                <!-- Profile Card with two badges, badges right, icons left -->
                <div class="profile-card" id="profile-btn">
                    <img src="Assets/log-out.svg" alt="Logout" class="profile-logout">
                    <span class="profile-name">User</span>
                    <img src="Assets/cog.svg" alt="Settings" class="settings-icon">
                    <img src="Assets/–ë–µ–π–¥–∂1 1.png" alt="Badge Bottom" class="profile-badge-bottom">
                    <img src="Assets/–ë–µ–π–¥–∂2 1.png" alt="Badge Top" class="profile-badge-top">
                </div>
        </header>
        
        <!-- Door decoration -->
        <div class="door"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <h1 class="page-title">Join the room</h1>
            
            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <img src="Assets/search.svg" alt="Search" class="search-icon">
                    <input type="text" class="search-input" placeholder="search by name.">
                </div>
                <button class="filter-btn">
                    <img src="Assets/filter.svg" alt="Filter" class="filter-icon">
                </button>
            </div>
            
            <!-- Room List -->
            <div class="room-list">
                <!-- Room 1 -->
                <div class="room-card">
                    <div class="scootch-left"></div>
                    <div class="room-paper">
                        <div class="room-info">
                            <div class="room-name-row">
                                <span class="room-label">Room name:</span>
                                <span class="room-name">Mortis 12</span>
                            </div>
                            <div class="room-players-row">
                                <span class="players-label">Players in the room:</span>
                                <span class="players-count">12/12</span>
                                <span class="room-full">Full.</span>
                            </div>
                        </div>
                        <div class="room-status">
                            <span class="status-text waiting">Waiting to start.</span>
                            <button class="join-btn">Join</button>
                        </div>
                    </div>
                    <div class="scootch-right"></div>
                </div>
                
                <!-- Room 2 -->
                <div class="room-card">
                    <div class="scootch-left"></div>
                    <div class="room-paper">
                        <div class="room-info">
                            <div class="room-name-row">
                                <span class="room-label">Room name:</span>
                                <span class="room-name">44546</span>
                            </div>
                            <div class="room-players-row">
                                <span class="players-label">Players in the room:</span>
                                <span class="players-count">8/10</span>
                                <img src="Assets/Component 1.png" alt="Lock" class="lock-icon" style="width: 20px; opacity: 0.5;">
                            </div>
                        </div>
                        <div class="room-status">
                            <span class="status-text waiting">Waiting to start.</span>
                            <button class="join-btn">Join</button>
                        </div>
                    </div>
                    <div class="scootch-right"></div>
                </div>
                
                <!-- Room 3 -->
                <div class="room-card">
                    <div class="scootch-left"></div>
                    <div class="room-paper">
                        <div class="room-info">
                            <div class="room-name-row">
                                <span class="room-label">Room name:</span>
                                <span class="room-name">Chillin</span>
                            </div>
                            <div class="room-players-row">
                                <span class="players-label">Players in the room:</span>
                                <span class="players-count">7/12</span>
                            </div>
                        </div>
                        <div class="room-status">
                            <span class="status-text started">Game started.</span>
                            <button class="join-btn">Join</button>
                        </div>
                    </div>
                    <div class="scootch-right"></div>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="pagination">
                <button class="page-btn prev">
                    <img src="Assets/chevron-left.svg" alt="Previous">
                </button>
                <span class="page-text">Page</span>
                <span class="page-number">1/34</span>
                <button class="page-btn next">
                    <img src="Assets/chevron-left.svg" alt="Next" style="transform: rotate(180deg);">
                </button>
            </div>
            
            <!-- Create Room Button -->
            <button class="create-room-btn" id="create-room-btn">
                Create room
            </button>
        </main>
        
        <!-- Create Room Modal -->
        <div class="modal-overlay" id="create-modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-scootch-left"></div>
                <div class="modal-scootch-right"></div>
                <div class="modal-paper">
                    <h2 class="modal-title">–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</h2>
                    
                    <form id="create-room-form">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞ –∫—ñ–º–Ω–∞—Ç–∏:</label>
                            <input type="text" id="room-name" class="form-input" placeholder="–ú–æ—è –∫—ñ–º–Ω–∞—Ç–∞" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤:</label>
                            <select id="max-players" class="form-select">
                                <option value="4">4 –≥—Ä–∞–≤—Ü—ñ</option>
                                <option value="6" selected>6 –≥—Ä–∞–≤—Ü—ñ–≤</option>
                                <option value="8">8 –≥—Ä–∞–≤—Ü—ñ–≤</option>
                                <option value="10">10 –≥—Ä–∞–≤—Ü—ñ–≤</option>
                                <option value="12">12 –≥—Ä–∞–≤—Ü—ñ–≤</option>
                                <option value="15">15 –≥—Ä–∞–≤—Ü—ñ–≤</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ß–∞—Å –Ω–∞ —Ö—ñ–¥ (—Å–µ–∫—É–Ω–¥–∏):</label>
                            <select id="turn-duration" class="form-select">
                                <option value="60">1 —Ö–≤–∏–ª–∏–Ω–∞</option>
                                <option value="90">1.5 —Ö–≤–∏–ª–∏–Ω–∏</option>
                                <option value="120" selected>2 —Ö–≤–∏–ª–∏–Ω–∏</option>
                                <option value="180">3 —Ö–≤–∏–ª–∏–Ω–∏</option>
                                <option value="300">5 —Ö–≤–∏–ª–∏–Ω</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">–ß–∞—Å –Ω–∞ –≥–æ–ª–æ—Å—É–≤–∞–Ω–Ω—è (—Å–µ–∫—É–Ω–¥–∏):</label>
                            <select id="vote-duration" class="form-select">
                                <option value="30">30 —Å–µ–∫—É–Ω–¥</option>
                                <option value="45">45 —Å–µ–∫—É–Ω–¥</option>
                                <option value="60" selected>1 —Ö–≤–∏–ª–∏–Ω–∞</option>
                                <option value="90">1.5 —Ö–≤–∏–ª–∏–Ω–∏</option>
                            </select>
                        </div>
                        
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="is-private" class="form-checkbox">
                            <label for="is-private" class="form-label">–ü—Ä–∏–≤–∞—Ç–Ω–∞ –∫—ñ–º–Ω–∞—Ç–∞</label>
                        </div>
                        
                        <div class="form-group" id="password-group" style="display: none;">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                            <input type="password" id="room-password" class="form-input" placeholder="–ü–∞—Ä–æ–ª—å">
                        </div>
                        
                        <div class="modal-buttons">
                            <button type="submit" class="modal-btn create-btn">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                            <button type="button" class="modal-btn cancel-btn" id="cancel-create">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Join Room Modal (for password protected rooms) -->
        <div class="modal-overlay" id="join-modal" style="display: none;">
            <div class="modal-content small">
                <div class="modal-paper">
                    <h2 class="modal-title">–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å</h2>
                    
                    <form id="join-room-form">
                        <div class="form-group">
                            <label class="form-label">–ü–∞—Ä–æ–ª—å:</label>
                            <input type="password" id="join-password" class="form-input" placeholder="–ü–∞—Ä–æ–ª—å" required>
                        </div>
                        
                        <div class="modal-buttons">
                            <button type="submit" class="modal-btn create-btn">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å</button>
                            <button type="button" class="modal-btn cancel-btn" id="cancel-join">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script>
        let currentUser = null;
        let rooms = [];
        let currentPage = 1;
        const roomsPerPage = 5;
        let joiningRoomId = null;
        
        // Initialize
        async function init() {
            currentUser = await window.supabaseAuth.getCurrentUser();
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            document.querySelector('.profile-name').textContent = 
                currentUser.user_metadata?.name || currentUser.email.split('@')[0];
            
            await loadRooms();
            setupRealtimeUpdates();
        }
        
        // Load rooms from Supabase
        async function loadRooms() {
            const client = window.supabaseAuth.initSupabase();
            
            const { data, error } = await client
                .from('rooms')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Error loading rooms:', error);
                return;
            }
            
            rooms = data || [];
            renderRooms();
        }
        
        // Render rooms list
        function renderRooms() {
            const roomList = document.querySelector('.room-list');
            const searchTerm = document.querySelector('.search-input').value.toLowerCase();
            
            // Filter rooms by search term
            let filteredRooms = rooms.filter(room => 
                room.name.toLowerCase().includes(searchTerm)
            );
            
            // Pagination
            const totalPages = Math.ceil(filteredRooms.length / roomsPerPage) || 1;
            const startIndex = (currentPage - 1) * roomsPerPage;
            const paginatedRooms = filteredRooms.slice(startIndex, startIndex + roomsPerPage);
            
            // Update pagination
            document.querySelector('.page-number').textContent = `${currentPage}/${totalPages}`;
            
            // Clear and render
            roomList.innerHTML = '';
            
            if (paginatedRooms.length === 0) {
                roomList.innerHTML = '<p class="no-rooms">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç</p>';
                return;
            }
            
            paginatedRooms.forEach(room => {
                const playerCount = room.players ? room.players.length : 0;
                const isFull = playerCount >= room.max_players;
                const isStarted = room.status === 'started';
                
                const roomCard = document.createElement('div');
                roomCard.className = 'room-card';
                roomCard.innerHTML = `
                    <div class="scootch-left"></div>
                    <div class="room-paper">
                        <div class="room-info">
                            <div class="room-name-row">
                                <span class="room-label">Room name:</span>
                                <span class="room-name">${room.name}</span>
                            </div>
                            <div class="room-players-row">
                                <span class="players-label">Players in the room:</span>
                                <span class="players-count">${playerCount}/${room.max_players}</span>
                                ${isFull ? '<span class="room-full">Full.</span>' : ''}
                                ${room.is_private ? '<span class="room-private">üîí</span>' : ''}
                            </div>
                        </div>
                        <div class="room-status">
                            <span class="status-text ${isStarted ? 'started' : 'waiting'}">
                                ${isStarted ? 'Game started.' : 'Waiting to start.'}
                            </span>
                            <button class="join-btn" data-room-id="${room.id}" 
                                ${isFull || isStarted ? 'disabled' : ''}>Join</button>
                        </div>
                    </div>
                    <div class="scootch-right"></div>
                `;
                
                roomList.appendChild(roomCard);
            });
            
            // Add event listeners to join buttons
            document.querySelectorAll('.join-btn').forEach(btn => {
                btn.addEventListener('click', () => handleJoinRoom(btn.dataset.roomId));
            });
        }
        
        // Setup realtime updates
        function setupRealtimeUpdates() {
            const client = window.supabaseAuth.initSupabase();
            
            client
                .channel('rooms-channel')
                .on('postgres_changes', { 
                    event: '*', 
                    schema: 'public', 
                    table: 'rooms'
                }, () => {
                    loadRooms();
                })
                .subscribe();
        }
        
        // Handle join room
        async function handleJoinRoom(roomId) {
            const room = rooms.find(r => r.id === roomId);
            if (!room) return;
            
            if (room.is_private) {
                joiningRoomId = roomId;
                document.getElementById('join-modal').style.display = 'flex';
                return;
            }
            
            await joinRoom(roomId);
        }
        
        // Join room
        async function joinRoom(roomId, password = null) {
            const client = window.supabaseAuth.initSupabase();
            const room = rooms.find(r => r.id === roomId);
            
            if (!room) return;
            
            // Check password for private rooms
            if (room.is_private && room.password !== password) {
                alert('–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å!');
                return;
            }
            
            // Add player to room
            const players = room.players || [];
            const playerData = {
                id: currentUser.id,
                name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
                ready: false
            };
            
            // Check if already in room
            if (players.some(p => p.id === currentUser.id)) {
                window.location.href = `lobby.html?id=${roomId}`;
                return;
            }
            
            players.push(playerData);
            
            const { error } = await client
                .from('rooms')
                .update({ players: players })
                .eq('id', roomId);
            
            if (error) {
                console.error('Error joining room:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—Ä–∏—î–¥–Ω–∞–Ω–Ω—ñ –¥–æ –∫—ñ–º–Ω–∞—Ç–∏');
                return;
            }
            
            window.location.href = `lobby.html?id=${roomId}`;
        }
        
        // Create room
        async function createRoom(name, maxPlayers, isPrivate, password, turnDuration, voteDuration) {
            const client = window.supabaseAuth.initSupabase();
            
            const roomData = {
                name: name,
                max_players: parseInt(maxPlayers),
                is_private: isPrivate,
                password: isPrivate ? password : null,
                host_id: currentUser.id,
                status: 'waiting',
                turn_duration: parseInt(turnDuration),
                vote_duration: parseInt(voteDuration),
                players: [{
                    id: currentUser.id,
                    name: currentUser.user_metadata?.name || currentUser.email.split('@')[0],
                    ready: false
                }]
            };
            
            const { data, error } = await client
                .from('rooms')
                .insert(roomData)
                .select()
                .single();
            
            if (error) {
                console.error('Error creating room:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—ñ –∫—ñ–º–Ω–∞—Ç–∏');
                return;
            }
            
            window.location.href = `lobby.html?id=${data.id}`;
        }
        
        // Event Listeners
        
        // Create room button
        document.getElementById('create-room-btn').addEventListener('click', () => {
            document.getElementById('create-modal').style.display = 'flex';
        });
        
        // Cancel create
        document.getElementById('cancel-create').addEventListener('click', () => {
            document.getElementById('create-modal').style.display = 'none';
        });
        
        // Cancel join
        document.getElementById('cancel-join').addEventListener('click', () => {
            document.getElementById('join-modal').style.display = 'none';
            joiningRoomId = null;
        });
        
        // Private checkbox toggle
        document.getElementById('is-private').addEventListener('change', (e) => {
            document.getElementById('password-group').style.display = 
                e.target.checked ? 'block' : 'none';
        });
        
        // Create room form
        document.getElementById('create-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('room-name').value;
            const maxPlayers = document.getElementById('max-players').value;
            const isPrivate = document.getElementById('is-private').checked;
            const password = document.getElementById('room-password').value;
            const turnDuration = document.getElementById('turn-duration').value;
            const voteDuration = document.getElementById('vote-duration').value;
            
            await createRoom(name, maxPlayers, isPrivate, password, turnDuration, voteDuration);
        });
        
        // Join room form (password)
        document.getElementById('join-room-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const password = document.getElementById('join-password').value;
            await joinRoom(joiningRoomId, password);
            
            document.getElementById('join-modal').style.display = 'none';
            joiningRoomId = null;
        });
        
        // Search input
        document.querySelector('.search-input').addEventListener('input', () => {
            currentPage = 1;
            renderRooms();
        });
        
        // Pagination
        document.querySelector('.page-btn.prev').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderRooms();
            }
        });
        
        document.querySelector('.page-btn.next').addEventListener('click', () => {
            const totalPages = Math.ceil(rooms.length / roomsPerPage) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                renderRooms();
            }
        });
        
        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
        
        // Logout
        document.querySelector('.profile-logout').addEventListener('click', async (e) => {
            e.stopPropagation();
            await window.supabaseAuth.signOut();
            window.location.href = 'index.html';
        });
        
        init();
    </script>
</body>
</html>
